<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-size: 0.95em;
        }

        .metric-value {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
        }

        .cluster-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .cluster-title {
            font-size: 1.4em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cluster-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .forecast-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .forecast-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .forecast-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: scale(1.05);
        }

        #fileInput {
            display: none;
        }

        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .chart-container img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        footer {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .team-info {
            color: #666;
            font-size: 0.95em;
        }

        .toggle-btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: #f0f0ff;
            transform: translateY(-2px);
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI-Powered E-commerce Analytics</h1>
            <p class="subtitle">Real-time Customer Segmentation & Sales Forecasting</p>
            <div style="display: inline-block; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 8px 20px; border-radius: 20px; font-size: 0.9em; margin-top: 10px; font-weight: 600;">
                ‚ú® Powered by K-Means & Prophet AI Models
            </div>
            <p class="team-info" style="margin-top: 15px;">
                <strong>Team:</strong> Sereno, Page, Dulce, Laudato | 
                <strong>Teacher:</strong> Sir Charlston Sean Gono
            </p>
        </header>

        <!-- Customer Input Section -->
        <div class="upload-section">
            <h2 style="margin-bottom: 20px; color: #333;">üë§ Customer Segmentation</h2>
            <div class="dashboard-grid">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Recency (days since last purchase)</label>
                    <input type="number" id="recency" placeholder="e.g., 30" min="0" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Frequency (number of purchases)</label>
                    <input type="number" id="frequency" placeholder="e.g., 5" min="0" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Monetary (total spending in ¬£)</label>
                    <input type="number" id="monetary" placeholder="e.g., 1500" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
            </div>
            <button class="upload-btn" onclick="predictCustomerSegment()">üéØ Predict Customer Segment</button>
            <div id="segmentResult"></div>
        </div>

        <!-- Sales Forecast Input Section -->
        <div class="upload-section" style="margin-top: 20px;">
            <h2 style="margin-bottom: 20px; color: #333;">üìà Sales Forecast</h2>
            <div class="dashboard-grid">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Start Date for Forecast</label>
                    <input type="date" id="forecastDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #333; font-weight: 600; margin-bottom: 8px;">Number of Days to Forecast</label>
                    <input type="number" id="forecastDays" placeholder="e.g., 7" min="1" max="90" value="7" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>
            </div>
            <button class="upload-btn" onclick="predictSalesForecast()">üìä Generate Forecast</button>
            <div id="forecastResult"></div>
        </div>

        <!-- Results Display -->
        <div id="resultsSection" style="display: none; margin-top: 30px;">
            <!-- Customer Segment Results -->
            <div class="card">
                <div class="card-title">üéØ Customer Segment Analysis</div>
                <div id="segmentDisplay"></div>
            </div>

            <!-- Sales Forecast Results -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">üìà Sales Forecast</div>
                <div id="forecastDisplay"></div>
            </div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <!-- Forecast Toggle -->
            <div class="card" style="margin-bottom: 20px; text-align: center;">
                <div class="card-title">üìä Multi-Granularity Forecasting</div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
                    <button class="toggle-btn active" onclick="showForecast('daily')" id="dailyBtn">
                        üìÖ Daily Forecast (Tactical)
                    </button>
                    <button class="toggle-btn" onclick="showForecast('weekly')" id="weeklyBtn">
                        üìà Weekly Forecast (Strategic)
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-title" id="forecastTitle">üìà Daily Sales Forecast</div>
                    <div class="metric">
                        <span class="metric-label" id="avgLabel">Average Daily Sales</span>
                        <span class="metric-value" id="avgSales">$0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label" id="projectionLabel">30-Day Projection</span>
                        <span class="metric-value" id="projected30">$0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Uncertainty Range</span>
                        <span class="metric-value" id="uncertaintyRange">¬±0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Model Accuracy (MAPE)</span>
                        <span class="metric-value" id="mape">0%</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üë• Customer Analytics</div>
                    <div class="metric">
                        <span class="metric-label">Total Customers</span>
                        <span class="metric-value" id="totalCustomers">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Customer Segments</span>
                        <span class="metric-value" id="numClusters">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Revenue</span>
                        <span class="metric-value" id="totalRevenue">$0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Model R¬≤ Score</span>
                        <span class="metric-value" id="r2Score">0.0000</span>
                    </div>
                </div>
            </div>

            <!-- Customer Segments -->
            <div class="card">
                <div class="card-title">üéØ Customer Segments</div>
                <div id="clusterContainer"></div>
            </div>

            <!-- Sales Forecast Table -->
            <div class="card">
                <div class="card-title" id="forecastTableTitle">üìÖ Next 7 Days Sales Forecast</div>
                <table class="forecast-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Predicted Sales</th>
                            <th>Lower Bound</th>
                            <th>Upper Bound</th>
                            <th>Uncertainty</th>
                        </tr>
                    </thead>
                    <tbody id="forecastTable"></tbody>
                </table>
            </div>

            <!-- Charts Section -->
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-title">üìä Visualizations</div>
                    <p style="color: #666; margin-bottom: 15px;">
                        Charts are saved as PNG files from the notebook:
                    </p>
                    <ul style="color: #666; line-height: 1.8; list-style-position: inside;">
                        <li>rfm_distributions.png</li>
                        <li>elbow_method.png</li>
                        <li>customer_segments_3d.png</li>
                        <li>sales_forecast.png</li>
                        <li>forecast_components.png</li>
                    </ul>
                </div>

                <div class="card">
                    <div class="card-title">üí° Key Insights</div>
                    <div id="insightsContainer"></div>
                </div>
            </div>
        </div>

        <footer>
            <p class="team-info">
                <strong>Advanced Data Mining for Customer Segmentation and Sales Forecasting</strong><br>
                An Analytics Framework for E-commerce Optimization
            </p>
        </footer>
    </div>

    <script>
        // API configuration
        const API_BASE_URL = 'http://localhost:5000';

        const clusterNames = {
            0: 'üí§ Lost Customers',
            1: '‚ö†Ô∏è At Risk',
            2: 'üíô Loyal Customers',
            3: 'üëë Champions'
        };

        const clusterDescriptions = {
            0: 'Customers who haven\'t purchased recently and have low engagement. Need win-back campaigns.',
            1: 'Previously active customers showing declining engagement. Require re-engagement strategies.',
            2: 'Frequent buyers with consistent spending. Focus on loyalty rewards and retention.',
            3: 'High-value, recent buyers with frequent purchases. Target for VIP programs and upselling.'
        };

        // Set default date to today
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('forecastDate').valueAsDate = new Date();
            checkAPIStatus();
        });

        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    console.log('‚úÖ API Server is running');
                } else {
                    console.warn('‚ö†Ô∏è API Server responded with error');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è API Server not available. Make sure to run: python backend/api.py');
            }
        }

        async function predictCustomerSegment() {
            const recency = parseFloat(document.getElementById('recency').value);
            const frequency = parseFloat(document.getElementById('frequency').value);
            const monetary = parseFloat(document.getElementById('monetary').value);
            const resultDiv = document.getElementById('segmentResult');

            // Validate inputs
            if (isNaN(recency) || isNaN(frequency) || isNaN(monetary)) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 15px;">‚ö†Ô∏è Please fill in all customer fields</div>';
                return;
            }

            resultDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-size: 1.1em;">üîÑ Analyzing customer data with K-Means model...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/predict/segment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ recency, frequency, monetary })
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySegmentResult(data, resultDiv);
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 15px;">‚ùå Error: ${error.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 15px;">‚ùå Cannot connect to API. Please make sure the Flask server is running:<br><code>python backend/api.py</code></div>';
            }
        }

        function displaySegmentResult(data, resultDiv) {
            resultDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    ‚úÖ <strong>Analysis Complete!</strong><br>
                    Customer Segment: <strong>${data.cluster_name}</strong>
                </div>
            `;

            // Display detailed results
            document.getElementById('resultsSection').style.display = 'block';
            
            const clusterGradients = {
                0: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                1: 'linear-gradient(135deg, #ffa751 0%, #ffe259 100%)',
                2: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                3: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)'
            };

            document.getElementById('segmentDisplay').innerHTML = `
                <div style="background: ${clusterGradients[data.cluster]}; color: white; padding: 25px; border-radius: 12px;">
                    <div style="font-size: 1.6em; margin-bottom: 15px; font-weight: bold;">${data.cluster_name}</div>
                    <p style="margin: 15px 0; line-height: 1.6;">${data.description}</p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Recency</div>
                            <div style="font-size: 1.4em; font-weight: bold;">${data.rfm_values.recency} days</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Frequency</div>
                            <div style="font-size: 1.4em; font-weight: bold;">${data.rfm_values.frequency}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Monetary</div>
                            <div style="font-size: 1.4em; font-weight: bold;">¬£${data.rfm_values.monetary.toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Segment</div>
                            <div style="font-size: 1.4em; font-weight: bold;">Cluster ${data.cluster}</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #333; margin-bottom: 15px;">üí° Recommended Actions:</h3>
                    <ul style="color: #666; line-height: 2.2; padding-left: 20px;">
                        ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function predictSalesForecast() {
            const startDate = document.getElementById('forecastDate').value;
            const periods = parseInt(document.getElementById('forecastDays').value);
            const resultDiv = document.getElementById('forecastResult');

            // Validate inputs
            if (!startDate || isNaN(periods) || periods < 1) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 15px;">‚ö†Ô∏è Please select a date and number of days</div>';
                return;
            }

            resultDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-size: 1.1em;">üîÑ Generating forecast with Prophet model...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/predict/forecast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ start_date: startDate, periods: periods })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayForecastResult(data, resultDiv);
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 15px;">‚ùå Error: ${error.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 15px;">‚ùå Cannot connect to API. Please make sure the Flask server is running:<br><code>python backend/api.py</code></div>';
            }
        }

        function displayForecastResult(data, resultDiv) {
            resultDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    ‚úÖ <strong>Forecast Generated!</strong><br>
                    ${data.summary.periods}-day forecast starting from ${data.summary.start_date}
                </div>
            `;

            // Display forecast table
            document.getElementById('resultsSection').style.display = 'block';
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 12px; text-align: left;">Date</th>
                            <th style="padding: 12px; text-align: left;">Predicted Sales</th>
                            <th style="padding: 12px; text-align: left;">Lower Bound</th>
                            <th style="padding: 12px; text-align: left;">Upper Bound</th>
                            <th style="padding: 12px; text-align: left;">Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forecast.forEach(row => {
                const uncertaintyPct = ((row.yhat_upper - row.yhat_lower) / row.yhat) * 100;
                const confidence = 100 - uncertaintyPct;
                const badgeClass = confidence > 70 ? 'badge-success' : confidence > 50 ? 'badge-warning' : 'badge-danger';
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">${row.ds}</td>
                        <td style="padding: 12px;"><strong>${formatCurrency(row.yhat)}</strong></td>
                        <td style="padding: 12px;">${formatCurrency(row.yhat_lower)}</td>
                        <td style="padding: 12px;">${formatCurrency(row.yhat_upper)}</td>
                        <td style="padding: 12px;"><span class="status-badge ${badgeClass}">${confidence.toFixed(1)}%</span></td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';

            tableHTML += `
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="color: #333; margin-bottom: 15px;">üìä Forecast Summary</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
                        <span style="color: #666;">Average Daily Sales</span>
                        <span style="color: #667eea; font-weight: bold; font-size: 1.1em;">${formatCurrency(data.summary.avg_daily_sales)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
                        <span style="color: #666;">Total ${data.summary.periods}-Day Projection</span>
                        <span style="color: #667eea; font-weight: bold; font-size: 1.1em;">${formatCurrency(data.summary.total_projected)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0;">
                        <span style="color: #666;">Uncertainty Range</span>
                        <span style="color: #667eea; font-weight: bold; font-size: 1.1em;">${data.summary.uncertainty_range}</span>
                    </div>
                </div>
            `;

            document.getElementById('forecastDisplay').innerHTML = tableHTML;

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function formatCurrency(value) {
            return '¬£' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
    </script>
</body>
</html>
